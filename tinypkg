#!/usr/bin/env bash
#
# tinypkg Package Manager
# Manages packages from tinypkg-repo with YAML manifest support
#
# Real structure:
# packages/
# ├── index.yaml        (metadata for all packages)
# └── <package>/
#     └── manifest.yaml (build/install instructions)
#

set -euo pipefail

# Configuration
TINYPKG_REPO="${TINYPKG_REPO:-https://github.com/Night-Traders-Dev/tinypkg-repo.git}"
TINYPKG_DIR="${HOME}/.tinypkg"
TINYPKG_CACHE="${TINYPKG_DIR}/cache"
TINYPKG_INSTALLED="${TINYPKG_DIR}/installed"
TINYPKG_BUILD="${TINYPKG_DIR}/build"
PREFIX="${PREFIX:-${TINYPKG_DIR}/opt}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Logging
log_info() { echo -e "${BLUE}[•]${NC} $*"; }
log_success() { echo -e "${GREEN}[✓]${NC} $*"; }
log_warning() { echo -e "${YELLOW}[!]${NC} $*"; }
log_error() { echo -e "${RED}[✗]${NC} $*" >&2; }
log_step() { echo -e "${CYAN}==>${NC} $*"; }

# Check for yq (YAML parser)
check_yq() {
    if ! command -v yq &> /dev/null; then
        log_error "yq is required for YAML parsing. Install with:"
        echo "  Ubuntu/Debian: sudo apt install yq"
        echo "  macOS: brew install yq"
        echo "  Or download from: https://github.com/mikefarah/yq/releases"
        exit 1
    fi
}

# Initialize directories
init_tinypkg() {
    if [[ ! -d "$TINYPKG_DIR" ]]; then
        log_info "Initializing tinypkg at $TINYPKG_DIR"
        mkdir -p "$TINYPKG_CACHE" "$TINYPKG_INSTALLED" "$TINYPKG_BUILD" "$PREFIX"
        log_success "tinypkg initialized"
    fi
}

# Clone/update repository
update_repo() {
    local repo_path="${TINYPKG_CACHE}/repo"

    log_step "Updating tinypkg repository"

    if [[ -d "$repo_path" ]]; then
        log_info "Pulling latest changes..."
        cd "$repo_path"
        git pull --quiet origin main 2>/dev/null || git pull --quiet origin master 2>/dev/null || {
            log_warning "Could not auto-update, skipping"
        }
        cd - > /dev/null
    else
        log_info "Cloning repository..."
        git clone --quiet "$TINYPKG_REPO" "$repo_path" || {
            log_error "Failed to clone repository"
            return 1
        }
    fi

    log_success "Repository up to date"
}

# Parse index.yaml and list packages
list_packages() {
    local index_file="${TINYPKG_CACHE}/repo/packages/index.yaml"

    if [[ ! -f "$index_file" ]]; then
        log_error "packages/index.yaml not found. Run 'update' first."
        return 1
    fi

    log_info "Available packages:"
    echo ""

    # Use yq to parse YAML
    yq eval '.packages | keys[]' "$index_file" 2>/dev/null | while read -r pkg_name; do
        local version
        local description

        version=$(yq eval ".packages.${pkg_name}.version" "$index_file" 2>/dev/null || echo "unknown")
        description=$(yq eval ".packages.${pkg_name}.description" "$index_file" 2>/dev/null || echo "")

        printf "  ${CYAN}%-20s${NC}  v%-12s  %s\n" "$pkg_name" "$version" "$description"
    done
    echo ""
}

# List installed packages
list_installed() {
    if [[ ! -d "$TINYPKG_INSTALLED" ]] || [[ -z "$(ls -A "$TINYPKG_INSTALLED" 2>/dev/null)" ]]; then
        log_info "No packages installed"
        return 0
    fi

    log_info "Installed packages:"
    echo ""

    ls -1 "$TINYPKG_INSTALLED" | while read -r pkg; do
        local info_file="$TINYPKG_INSTALLED/$pkg/.tinypkg-info"
        if [[ -f "$info_file" ]]; then
            local version
            version=$(grep '^VERSION=' "$info_file" 2>/dev/null | cut -d'=' -f2 || echo "unknown")
            local installed
            installed=$(grep '^INSTALLED=' "$info_file" 2>/dev/null | cut -d'=' -f2 || echo "?")
            printf "  ${CYAN}%-20s${NC}  v%-12s  installed: %s\n" "$pkg" "$version" "$installed"
        else
            printf "  ${CYAN}%-20s${NC}\n" "$pkg"
        fi
    done
    echo ""
}

# Show package info
show_info() {
    local pkg_name="$1"
    local manifest_file="${TINYPKG_CACHE}/repo/packages/${pkg_name}/manifest.yaml"

    if [[ ! -f "$manifest_file" ]]; then
        log_error "Package '$pkg_name' not found"
        return 1
    fi

    log_info "Package: $pkg_name"
    echo ""

    yq eval '.' "$manifest_file" | while read -r line; do
        echo "  $line"
    done
    echo ""
}

# Verify checksum
verify_checksum() {
    local file="$1"
    local expected="$2"

    if [[ -z "$expected" ]] || [[ "$expected" == "null" ]]; then
        log_warning "No checksum provided, skipping verification"
        return 0
    fi

    log_info "Verifying checksum..."
    local algorithm
    algorithm=$(echo "$expected" | cut -d':' -f1)
    local hash
    hash=$(echo "$expected" | cut -d':' -f2)

    case "$algorithm" in
        sha256)
            if command -v sha256sum &>/dev/null; then
                echo "$hash  $file" | sha256sum -c - > /dev/null 2>&1
            else
                log_warning "sha256sum not available, skipping"
            fi
            ;;
        *)
            log_warning "Unknown checksum algorithm: $algorithm"
            ;;
    esac
}

# Download source
download_source() {
    local url="$1"
    local dest="$2"

    log_info "Downloading: $url"

    if command -v curl &>/dev/null; then
        curl -fL -o "$dest" "$url" 2>/dev/null
    elif command -v wget &>/dev/null; then
        wget -q -O "$dest" "$url"
    else
        log_error "curl or wget required"
        return 1
    fi
}

# Build package from manifest
build_package() {
    local pkg_name="$1"
    local manifest_file="${TINYPKG_CACHE}/repo/packages/${pkg_name}/manifest.yaml"
    local build_dir="${TINYPKG_BUILD}/${pkg_name}"

    if [[ ! -f "$manifest_file" ]]; then
        log_error "Manifest not found for $pkg_name"
        return 1
    fi

    log_step "Building $pkg_name"

    # Extract metadata
    local source
    local build_script
    local install_script
    local checksum

    source=$(yq eval '.source' "$manifest_file" 2>/dev/null)
    build_script=$(yq eval '.build' "$manifest_file" 2>/dev/null)
    install_script=$(yq eval '.install' "$manifest_file" 2>/dev/null)
    checksum=$(yq eval '.checksum' "$manifest_file" 2>/dev/null)

    # Create build directory
    rm -rf "$build_dir"
    mkdir -p "$build_dir"
    cd "$build_dir"

    # Download source
    if [[ -n "$source" ]] && [[ "$source" != "null" ]]; then
        local filename
        filename=$(basename "$source")
        download_source "$source" "$filename"

        # Verify checksum
        if [[ -n "$checksum" ]] && [[ "$checksum" != "null" ]]; then
            verify_checksum "$filename" "$checksum"
        fi

        # Extract
        if [[ "$filename" == *.tar.gz ]]; then
            log_info "Extracting tarball..."
            tar xzf "$filename"
        elif [[ "$filename" == *.tar.xz ]]; then
            tar xJf "$filename"
        elif [[ "$filename" == *.zip ]]; then
            unzip -q "$filename"
        fi
    fi

    # Run build script
    if [[ -n "$build_script" ]] && [[ "$build_script" != "null" ]]; then
        log_info "Running build script..."
        export PREFIX
        bash -c "$build_script" || {
            log_error "Build failed"
            return 1
        }
    fi

    log_success "Build completed"
}

# Install package
install_package() {
    local pkg_name="$1"
    local manifest_file="${TINYPKG_CACHE}/repo/packages/${pkg_name}/manifest.yaml"
    local install_script
    local version
    local install_dir

    if [[ ! -f "$manifest_file" ]]; then
        log_error "Package '$pkg_name' not found"
        return 1
    fi

    install_dir="$TINYPKG_INSTALLED/$pkg_name"

    if [[ -d "$install_dir" ]]; then
        log_warning "Package '$pkg_name' already installed"
        return 0
    fi

    # Build first
    build_package "$pkg_name" || return 1

    log_step "Installing $pkg_name"

    # Extract install script
    install_script=$(yq eval '.install' "$manifest_file" 2>/dev/null)
    version=$(yq eval '.version' "$manifest_file" 2>/dev/null)

    # Run install script
    if [[ -n "$install_script" ]] && [[ "$install_script" != "null" ]]; then
        export PREFIX
        cd "${TINYPKG_BUILD}/${pkg_name}"
        bash -c "$install_script" || {
            log_error "Installation failed"
            return 1
        }
    fi

    # Record installation
    mkdir -p "$install_dir"
    {
        echo "PACKAGE=$pkg_name"
        echo "VERSION=$version"
        echo "INSTALLED=$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "PREFIX=$PREFIX"
    } > "$install_dir/.tinypkg-info"

    log_success "Package '$pkg_name' v$version installed to $PREFIX"
    echo ""
    echo "  Binary location: $PREFIX/bin/$pkg_name"
    echo "  Installation info: $install_dir/.tinypkg-info"
}

# Remove package
remove_package() {
    local pkg_name="$1"
    local install_dir="$TINYPKG_INSTALLED/$pkg_name"

    if [[ ! -d "$install_dir" ]]; then
        log_error "Package '$pkg_name' not installed"
        return 1
    fi

    log_step "Removing $pkg_name"

    # For safety, we don't remove binaries directly (user may have customized PREFIX)
    rm -rf "$install_dir"

    log_success "Package metadata removed. To fully uninstall:"
    echo "  rm -rf $PREFIX/bin/$pkg_name"
    echo "  rm -rf $PREFIX/share/$pkg_name"
}

# Search packages
search_packages() {
    local query="$1"
    local index_file="${TINYPKG_CACHE}/repo/packages/index.yaml"

    if [[ ! -f "$index_file" ]]; then
        log_error "Repository not found. Run 'update' first."
        return 1
    fi

    log_info "Searching for: $query"
    echo ""

    yq eval '.packages | keys[]' "$index_file" 2>/dev/null | grep -i "$query" | while read -r pkg_name; do
        local version
        version=$(yq eval ".packages.${pkg_name}.version" "$index_file" 2>/dev/null)
        printf "  ${CYAN}%-20s${NC}  v%s\n" "$pkg_name" "$version"
    done
    echo ""
}

# Show help
show_usage() {
    cat << 'EOF'

╔═══════════════════════════════════════════════════════════════╗
║           tinypkg - Minimal Package Manager v2                ║
║      Built for Night-Traders-Dev/tinypkg-repo                ║
╚═══════════════════════════════════════════════════════════════╝

USAGE:
  tinypkg [command] [arguments]

COMMANDS:
  init              Initialize tinypkg environment
  update            Update package repository
  list              List available packages
  installed         List installed packages
  install <pkg>     Build and install a package
  remove <pkg>      Remove an installed package
  info <pkg>        Show package information
  search <query>    Search for packages
  help              Show this help message

ENVIRONMENT VARIABLES:
  TINYPKG_REPO      Repository URL
                    (default: Night-Traders-Dev/tinypkg-repo)
  TINYPKG_DIR       Installation root directory
                    (default: ~/.tinypkg)
  PREFIX            Installation prefix for binaries
                    (default: ~/.tinypkg/opt)

DIRECTORY STRUCTURE:
  ~/.tinypkg/
  ├── cache/repo/        Repository clone
  ├── build/             Build artifacts
  ├── installed/         Package metadata
  └── opt/               Installed binaries & libraries

EXAMPLES:
  tinypkg init
  tinypkg update
  tinypkg list
  tinypkg install vim
  tinypkg search text
  tinypkg info neovim
  tinypkg installed
  tinypkg remove tmux

REQUIREMENTS:
  • bash 4.0+
  • git
  • yq (YAML parser)
  • curl or wget
  • Standard build tools (gcc, make, etc.)

EOF
}

# Main dispatcher
main() {
    check_yq
    init_tinypkg

    case "${1:-help}" in
        init)
            init_tinypkg
            ;;
        update)
            update_repo
            ;;
        list)
            list_packages
            ;;
        installed)
            list_installed
            ;;
        install)
            if [[ -z "${2:-}" ]]; then
                log_error "Package name required: tinypkg install <package>"
                return 1
            fi
            install_package "$2"
            ;;
        remove)
            if [[ -z "${2:-}" ]]; then
                log_error "Package name required: tinypkg remove <package>"
                return 1
            fi
            remove_package "$2"
            ;;
        info)
            if [[ -z "${2:-}" ]]; then
                log_error "Package name required: tinypkg info <package>"
                return 1
            fi
            show_info "$2"
            ;;
        search)
            if [[ -z "${2:-}" ]]; then
                log_error "Search query required: tinypkg search <query>"
                return 1
            fi
            search_packages "$2"
            ;;
        help)
            show_usage
            ;;
        *)
            log_error "Unknown command: $1"
            show_usage
            return 1
            ;;
    esac
}

main "$@"